<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Global user role variable
        let currentUserRole = 'viewer';
        
        // Get API base URL for network access
        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:5000/api';
            } else {
                return `http://${hostname}:5000/api`;
            }
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Verify token is still valid and get user info
            try {
                const response = await fetch(`${getApiBaseUrl()}/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    localStorage.removeItem('adminToken');
                    window.location.href = 'login.html';
                    return;
                }
                
                const userData = await response.json();
                currentUserRole = userData.user.role;
                console.log('Current user role:', currentUserRole);
                
                // Update user role indicator
                updateUserRoleIndicator(currentUserRole);
                
            } catch (error) {
                localStorage.removeItem('adminToken');
                window.location.href = 'login.html';
                return;
            }
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">User Management</h1>
                    <p class="text-sm text-gray-600">Manage admin users and permissions</p>
                </div>
                <div class="flex gap-4 items-center">
                    <div id="userRoleIndicator" class="px-3 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg border">
                        Logged in as: <span id="userRoleText">Loading...</span>
                    </div>
                    <a href="/admin.html" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Back to Admin
                    </a>
                    <button onclick="showAddUserModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Add New User
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Users Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">All Users (<span id="userCount">0</span>)</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Add New User</h3>
                <form id="addUserForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="newUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="newPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="newFullName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="newEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="newRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideAddUserModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Add User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Edit User</h3>
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="editUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="editFullName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="editEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="editRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="editIsActive" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700">Active</span>
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideEditUserModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Update User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Change Password</h3>
                <form id="changePasswordForm">
                    <input type="hidden" id="changePasswordUserId">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                        <input type="password" id="changePasswordInput" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideChangePasswordModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let users = [];
        
        // Helper function to get auth headers
        function getAuthHeaders() {
            const token = localStorage.getItem('adminToken');
            return {
                'Authorization': `Bearer ${token}`
            };
        }
        
        // Update user role indicator
        function updateUserRoleIndicator(role) {
            const roleText = document.getElementById('userRoleText');
            if (roleText) {
                const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);
                roleText.textContent = roleDisplay;
                
                // Add color coding based on role
                const indicator = document.getElementById('userRoleIndicator');
                if (indicator) {
                    switch(role) {
                        case 'admin':
                            indicator.className = 'px-3 py-2 text-sm font-medium text-red-800 bg-red-100 rounded-lg border border-red-200';
                            break;
                        case 'manager':
                            indicator.className = 'px-3 py-2 text-sm font-medium text-blue-800 bg-blue-100 rounded-lg border border-blue-200';
                            break;
                        case 'viewer':
                            indicator.className = 'px-3 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg border border-gray-200';
                            break;
                    }
                }
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await axios.get(`${getApiBaseUrl()}/users`, {
                    headers: getAuthHeaders()
                });
                
                if (response.data.success) {
                    users = response.data.users;
                    populateUsersTable();
                }
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load users: ' + (error.response?.data?.message || error.message));
            }
        }

        function populateUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            const countSpan = document.getElementById('userCount');
            
            countSpan.textContent = users.length;
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            No users found
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = users.map(user => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${user.username}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            ${user.full_name || '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            ${user.email || '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getRoleColor(user.role)}">
                                ${user.role}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${user.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            ${new Date(user.created_at).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${(currentUserRole === 'manager' && user.role === 'admin') ? '' : `
                            <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-800 font-medium mr-3">
                                Edit
                            </button>
                            `}
                            ${(currentUserRole === 'manager' && user.role === 'admin') ? '' : `
                            <button onclick="changeUserPassword(${user.id})" class="text-yellow-600 hover:text-yellow-800 font-medium mr-3">
                                Password
                            </button>
                            `}
                            ${(currentUserRole === 'manager' && user.role === 'admin') ? '' : `
                            <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800 font-medium">
                                Delete
                            </button>
                            `}
                        </td>
                    </tr>
                `).join('');
            }
        }

        function getRoleColor(role) {
            switch(role) {
                case 'admin': return 'bg-red-100 text-red-800';
                case 'manager': return 'bg-blue-100 text-blue-800';
                case 'viewer': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Modal functions
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
        }

        function hideAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserForm').reset();
        }

        function showEditUserModal(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editFullName').value = user.full_name || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editRole').value = user.role;
                document.getElementById('editIsActive').checked = user.is_active;
                document.getElementById('editUserModal').classList.remove('hidden');
            }
        }

        function hideEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
        }

        function showChangePasswordModal(userId) {
            document.getElementById('changePasswordUserId').value = userId;
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }

        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordForm').reset();
        }

        // User actions
        function editUser(userId) {
            showEditUserModal(userId);
        }

        function changeUserPassword(userId) {
            showChangePasswordModal(userId);
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            try {
                await axios.delete(`${getApiBaseUrl()}/users/${userId}`, {
                    headers: getAuthHeaders()
                });
                alert('User deleted successfully');
                loadUsers();
            } catch (error) {
                alert('Failed to delete user: ' + (error.response?.data?.message || error.message));
            }
        }

        // Form submissions
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value,
                    full_name: document.getElementById('newFullName').value,
                    email: document.getElementById('newEmail').value,
                    role: document.getElementById('newRole').value
                };
                
                await axios.post(`${getApiBaseUrl()}/users`, formData, {
                    headers: getAuthHeaders()
                });
                
                alert('User created successfully');
                hideAddUserModal();
                loadUsers();
            } catch (error) {
                alert('Failed to create user: ' + (error.response?.data?.message || error.message));
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const userId = document.getElementById('editUserId').value;
                const formData = {
                    username: document.getElementById('editUsername').value,
                    full_name: document.getElementById('editFullName').value,
                    email: document.getElementById('editEmail').value,
                    role: document.getElementById('editRole').value,
                    is_active: document.getElementById('editIsActive').checked
                };
                
                await axios.put(`${getApiBaseUrl()}/users/${userId}`, formData, {
                    headers: getAuthHeaders()
                });
                
                alert('User updated successfully');
                hideEditUserModal();
                loadUsers();
            } catch (error) {
                alert('Failed to update user: ' + (error.response?.data?.message || error.message));
            }
        });

        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const userId = document.getElementById('changePasswordUserId').value;
                const newPassword = document.getElementById('changePasswordInput').value;
                
                console.log('Changing password for user:', userId);
                console.log('Password length:', newPassword.length);
                console.log('Password value:', newPassword);
                
                if (!newPassword || newPassword.length < 6) {
                    alert('Password must be at least 6 characters long');
                    return;
                }
                
                await axios.post(`${getApiBaseUrl()}/users/${userId}/change-password`, {
                    new_password: newPassword
                }, {
                    headers: getAuthHeaders()
                });
                
                alert('Password changed successfully');
                hideChangePasswordModal();
            } catch (error) {
                alert('Failed to change password: ' + (error.response?.data?.message || error.message));
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });
    </script>
</body>
</html>
